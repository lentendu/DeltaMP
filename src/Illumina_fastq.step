# Define Variables
while read var val; do unset $var ; if [[ $val == "(["* ]]; then declare -A $var="`echo $val | sed 's/].\"/]=\"/g'`" ; else declare $var="$val" ; fi ; done < config/env.txt
. $BIN/check_previous_step

# load modules
module load DeltaMP/${VERSION[DELTAMP]}

# Library to analyse
read LIB_NAME FWD_SUF RVS_SUF <<<`sed -n ${ARRAY_TASK}'p' config/lib2.list`
FWD_LIB=${LIB_NAME}${FWD_SUF/.$RAW_EXT.*/}
RVS_LIB=${LIB_NAME}${RVS_SUF/.$RAW_EXT.*/}
cd libraries

# Primer clipping
if [ $CLIPPING == "yes" ]
then
	#FWDDIS=`awk -v F=${#FWD} -v D=$PDIFFS 'BEGIN{printf "%.2g\n", D/F}'`
	RVSDIS=`awk -v R=${#RVS} -v D=$PDIFFS 'BEGIN{printf "%.2g\n", D/R}'`
	DISS=`awk -v F=${#FWD} -v R=${#RVS} -v D=$PDIFFS 'BEGIN{DISS=D/F;if(D/R>DISS){DISS=D/R};printf "%.2g\n", DISS}'`
	# cutadapt
	cutadapt -g $FWD -G $RVS -e $DISS --trimmed-only --no-indels -o fastq/$LIB_NAME.fwd.fastq -p fastq/$LIB_NAME.rvs.fastq $FWD_LIB.fastq $RVS_LIB.fastq --info-file=raw_stat/$FWD_LIB.cutadapt > fastq/log.cutadapt.$LIB_NAME.txt
	cutadapt -g $RVS -O ${#RVS} -e $RVSDIS --no-indels --trimmed-only -o fastq/$LIB_NAME.rvs.tmp.fastq --info-file=raw_stat/$RVS_LIB.cutadapt $RVS_LIB.fastq > fastq/log.cutadapt.aux.$LIB_NAME.txt
	# primer logo
	weblogo -c classic -s large -t "$LIB_NAME: $FWD_NAME" < <(awk -v a=${#FWD} 'BEGIN{FS="\t"} NF==11{printf ">%s\n%*s\n",$1,a,$6}' raw_stat/$FWD_LIB.cutadapt | sed 's/ /N/g' )> raw_stat/weblogo.$LIB_NAME.forward.eps
	weblogo -c classic -s large -t "$LIB_NAME: primer $RVS_NAME" < <(awk -v a=${#RVS} 'BEGIN{FS="\t"} NF==11{printf ">%s\n%*s\n",$1,a,$6}' raw_stat/$RVS_LIB.cutadapt | sed 's/ /N/g') > raw_stat/weblogo.$LIB_NAME.reverse.eps
	rm fastq/$LIB_NAME.rvs.tmp.fastq
else
	ln -s $PWD/$FWD_LIB.fastq $PWD/fastq/$LIB_NAME.fwd.fastq
	ln -s $PWD/$RVS_LIB.fastq $PWD/fastq/$LIB_NAME.rvs.fastq
fi

# Convert to fasta + qual for raw reads stat
mothur "#set.dir(input=fastq, output=fasta);
	fastq.info(fastq=$LIB_NAME.fwd.fastq);
	fastq.info(fastq=$LIB_NAME.rvs.fastq)"
awk '$0!~"^>"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print int(sum/NF)}' fasta/$LIB_NAME.fwd.qual > raw_stat/$LIB_NAME.fwd.meanqual
awk '$0!~"^>"{for(i=1;i<=NF;i++){sum[i]+=$i;nb[i]+=1}}END{for(i=1;sum[i];i++){print int(sum[i]/nb[i])}}' fasta/$LIB_NAME.fwd.qual > raw_stat/$LIB_NAME.fwd.meanposqual
awk '$0!~"^>"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print int(sum/NF)}' fasta/$LIB_NAME.rvs.qual > raw_stat/$LIB_NAME.rvs.meanqual
awk '$0!~"^>"{for(i=1;i<=NF;i++){sum[i]+=$i;nb[i]+=1}}END{for(i=1;sum[i];i++){print int(sum[i]/nb[i])}}' fasta/$LIB_NAME.rvs.qual > raw_stat/$LIB_NAME.rvs.meanposqual

rm fasta/$LIB_NAME.fwd.fasta fasta/$LIB_NAME.fwd.qual fasta/$LIB_NAME.rvs.fasta fasta/$LIB_NAME.rvs.qual

# list files and directories
. $BIN/list_step_files.sh

echo END



