# 
# DeltaMP, a flexible, reproducible and resource efficient metabarcoding amplicon pipeline for HPC
# Copyright (C) 2018 Guillaume Lentendu, Christina Wei√übecker, Anna Heintz-Buschart, Tesfaye Wubet
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
# 

# load modules
module load DeltaMP/DELTAMP_VERSION

# Define Variables
while read var val; do unset $var ; if [[ $val == "(["* ]]; then declare -A $var="`echo $val | sed 's/].\"/]=\"/g'`" ; else declare $var="$val" ; fi ; done < config/env.txt
. $BIN/check_previous_step

# Library to analyse
read SAMPLE FWD_LIB RVS_LIB <<<`sed -n ${ARRAY_TASK}'{s/\.fastq//g;p}' config/lib3.list`
LIB_NAME=`printf "%s\n%s\n" $FWD_LIB $RVS_LIB | sed -e 'N;s/^\(.*\).*\n\1.*$/\1/'`

# Trim for optimization of sequence quality
cd libraries/fasta
if [ $DENOISE == "dada2" ]
then
	vsearch --fastq_eestats2 fastq/${LIB_NAME}.fwd.fastq.$EXT --length_cutoffs $MINLEN,*,5 --ee_cutoffs 0.5,1.0,2.0 --output fastq/${LIB_NAME}.fwd.eestat
else
	mothur "#set.logfile(name=mothur.$LIB_NAME.logfile, append=T);
	trim.seqs(fasta=$LIB_NAME.pairend.fasta, qfile=$LIB_NAME.pairend.qual, qaverage=$MINQUAL, minlength=$MINLEN, maxlength=$MAXLEN, maxambig=$MAXAMBIG, maxhomop=$MAXHOMOP, processors=1);
	make.fastq(fasta=$LIB_NAME.pairend.trim.fasta, qfile=$LIB_NAME.pairend.trim.qual)"
	
	vsearch --quiet --fastq_stats $LIB_NAME.pairend.trim.fastq --log $LIB_NAME.pairend_trim.stats
	sed -n '/^Read length distribution/,/^$/{s/>=//;p}' ${LIB_NAME}.pairend_trim.stats | awk '$3~"%"{print $1,$2}' | sort -k1,1n > ../raw_stat/$LIB_NAME.pairend_trim.length
	sed -n '/^Q score distribution/,/^$/p' ${LIB_NAME}.pairend_trim.stats | awk '$5~"%"{print $2,$4}' | sort -k 1,1 | join -a 1 -o 0,2.2 -e "0" <(seq 0 41 | sort -k 1,1) - | sort -k 1,1n | cut -d " " -f 2 > ../raw_stat/${LIB_NAME}.pairend_trim.meanqual
	sed -n '/RatePct/,/^$/p' ${LIB_NAME}.pairend_trim.stats | sed '1,2d;$d' | awk '{print $3}' > ../raw_stat/${LIB_NAME}.pairend_trim.meanposqual
	
	awk '$1!~">"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print sum/NF}' $LIB_NAME.pairend.trim.qual > $LIB_NAME.pairend.trim.qual.stat
	for i in $(seq $MINQUAL 30)
	do
		awk -v I=$i 'BEGIN{sum=0} $1>=I{sum+=1}END{print sum}' $LIB_NAME.pairend.trim.qual.stat
	done | tr "\n" "\t" | sed 's/$/\n/' > ../../quality_check/$LIB_NAME.stat

	rm $LIB_NAME.pairend_trim.stats $LIB_NAME.pairend.trim.fastq $LIB_NAME.pairend.trim.qual.stat $LIB_NAME.pairend.trim.fasta $LIB_NAME.pairend.scrap.fasta $LIB_NAME.pairend.trim.qual $LIB_NAME.pairend.scrap.qual
fi

# list files and directories
. $BIN/list_step_files.sh

echo END
