# Define Variables
while read var val; do unset $var ; if [[ $val == "(["* ]]; then declare -A $var="`echo $val | sed 's/].\"/]=\"/g'`" ; else declare $var="$val" ; fi ; done < config/env.txt
. $BIN/check_previous_step

# load modules
module load DeltaMP/${VERSION[DELTAMP]}

# Library to analyse
read SAMPLE FWD_LIB RVS_LIB <<<`sed -n ${ARRAY_TASK}'{s/\.fastq//g;p}' config/lib3.list`
LIB_NAME=`printf "%s\n%s\n" $FWD_LIB $RVS_LIB | sed -e 'N;s/^\(.*\).*\n\1.*$/\1/'`

# Trim with primers for archiving and optimization of sequence quality and 
cd libraries/fasta
mothur "#set.logfile(name=mothur.Illumina_opt.$LIB_NAME.logfile);
trim.seqs(fasta=$LIB_NAME.pairend.fasta, qfile=$LIB_NAME.pairend.qual, qaverage=$MINQUAL, minlength=$MINLEN, maxlength=$MAXLEN, maxambig=$MAXAMBIG, maxhomop=$MAXHOMOP)"

awk '$1!~">"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print sum/NF}' $LIB_NAME.pairend.trim.qual > $LIB_NAME.pairend.trim.qual.stat
if [ $MINQUAL -lt 30 ]
then
	for i in $(seq $MINQUAL 30)
	do
		awk -v I=$i 'BEGIN{sum=0} $1>=I{sum+=1}END{print sum}' $LIB_NAME.pairend.trim.qual.stat
	done | tr "\n" "\t" | sed 's/$/\n/' > ../../quality_check/$LIB_NAME.stat
fi
rm $LIB_NAME.pairend.trim.qual.stat

# list files and directories
. $BIN/list_step_files.sh

echo END
